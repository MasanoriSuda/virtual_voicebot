services:
  backend:
    build:
      context: ./virtual-voicebot-backend
      dockerfile: Dockerfile
      target: build
    container_name: virtual-voicebot-backend
    volumes:
      - ./virtual-voicebot-backend:/workspace
      - backend-target:/workspace/target
    environment:
      SIP_BIND_IP: 0.0.0.0
      SIP_PORT: 5060
      RTP_PORT: 10000
      LOCAL_IP: 0.0.0.0
      ADVERTISED_IP: 127.0.0.1
      RECORDING_HTTP_ADDR: 0.0.0.0:18080
      DATABASE_URL: postgres://voicebot:voicebot_dev@postgres:5432/voicebot
      OLLAMA_URL: http://ollama:11434
      VOICEVOX_URL: http://voicevox:50021
      ASR_PROVIDER: whisper
      LLM_PROVIDER: ollama
      TTS_PROVIDER: voicevox
      RUST_BACKTRACE: 1
      CARGO_INCREMENTAL: 1
    ports:
      - "5060:5060/udp"
      - "10000-10100:10000-10100/udp"
      - "18080:18080"
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
      voicevox:
        condition: service_started
    command: cargo watch -x "run --bin virtual-voicebot-backend"

  frontend:
    build:
      context: ./virtual-voicebot-frontend
      dockerfile: Dockerfile.dev
    container_name: virtual-voicebot-frontend
    volumes:
      - ./virtual-voicebot-frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      BACKEND_URL: http://backend:18080
    ports:
      - "3000:3000"
    depends_on:
      - backend
    command: pnpm dev --hostname 0.0.0.0 --port 3000

  postgres:
    image: postgres:16-alpine
    container_name: virtual-voicebot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: voicebot
      POSTGRES_USER: voicebot
      POSTGRES_PASSWORD: voicebot_dev
    ports:
      - "${POSTGRES_HOST_PORT:-5433}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U voicebot -d voicebot"]
      interval: 5s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    container_name: virtual-voicebot-ollama
    restart: unless-stopped
    ports:
      - "${OLLAMA_HOST_PORT:-11435}:11434"
    volumes:
      - ollama-data:/root/.ollama

  voicevox:
    image: voicevox/voicevox_engine:cpu-latest
    container_name: virtual-voicebot-voicevox
    restart: unless-stopped
    ports:
      - "${VOICEVOX_HOST_PORT:-50021}:50021"

volumes:
  backend-target:
  frontend-node-modules:
  postgres-data:
  ollama-data:
