# docs/todo_app_ai.md

## 挙動を変えないリファクタ
- [x] app モジュールの骨（README と stub）を用意し、対話状態管理の責務をコメントで明示する（呼び出しはまだ行わない）。
- [x] ai モジュールを asr/llm/tts のサブモジュール境界だけ切り出し、既存関数を薄いラッパで包む（挙動は同じ）。
- [x] session の `handle_bot_pipeline` を関数分割し、AI 呼び出し部分に「app/ai へ移行予定」コメントを付与する（挙動は維持）。
- [x] voice_bot_flow に沿ったイベント名のドラフトを docs/app/ai に追記し、現行コードとの差分を明示する（コードはまだ触らない）。
- [x] 既存の ai 関数 I/F（ファイルパス渡し等）の前後で責務境界をコメントに反映し、将来のチャネルI/Fに備える。

## 挙動を変えるリファクタ（責務移譲・配線変更）
- [ ] session→app のイベントチャネルを追加し、音声バッファ完了/通話開始/終了通知を app に送るようにする。
- [ ] app→ai::{asr,llm,tts} の呼び出し経路を実装し、AI呼び出しを session から完全排除する。
- [ ] ai::{asr,llm,tts} を独立I/F（PCM入力/テキスト入出力）に分割し、ストリーミング/チャンク単位の処理を導入する。
- [ ] app で対話状態/履歴を管理し、LLMプロンプト構築とTTSリクエスト生成を担う。セッションへの指示は SessionOut 経由に変更する。
- [ ] Bot音声の戻し経路を app→session→rtp に変更し、WAVファイル経由の暫定実装を撤去する。
- [ ] エラーポリシー（ASR失敗・LLM失敗・TTS失敗）の処理を app/ai に移し、session は終了/継続指示だけ受ける形にする。
- [ ] 新しいチャネル経路で1ターン（音声→ASR→LLM→TTS→RTP）のスモークを通し、旧 `handle_bot_pipeline` を削除する。
