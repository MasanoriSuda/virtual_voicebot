<!-- SOURCE_OF_TRUTH: Backend V字モデル・プロセス定義 -->
# プロセス定義書（PD）

> Virtual Voicebot Backend の開発プロセスを定義する

| 項目 | 値 |
|------|-----|
| ステータス | Draft |
| 作成日 | 2026-01-30 |
| 関連Issue | #69, #70 |

---

## 1. 開発アプローチ

本プロジェクトは **ストーリー駆動 × 仕様駆動** のハイブリッドを採用する。

### 1.1 ストーリー駆動の要素

- イシュー/ステアリング単位で変更を管理
- Why（背景・目的）を明示
- Who/When（段取り）を記録
- 変更の経緯を追跡可能にする

### 1.2 仕様駆動の要素

- 詳細仕様を先に定義してから実装
- AIに明確な入力を与える
- V字モデルに沿ったトレーサビリティ
- テストで仕様を検証

### 1.3 統合：ステアリングファイル

- イシューごとにステアリングファイルを作成
- ストーリー（Why/Who/When）+ 仕様（What/How）を一元管理
- 承認後に本体仕様書へマージ

---

## 2. V字モデル

```
【左辺：設計フェーズ】              【右辺：検証フェーズ】

要件定義（RD）◄─────────────────────►システムテスト（ST）
    │   「何を作るか」 ←トレース→ 「要求を満たすか」   │
    ▼                                                 ▲
基本設計（BD）◄─────────────────────►結合テスト（IT）
    │   「どう分けるか」←トレース→「繋がるか」        │
    ▼                                                 ▲
詳細設計（DD）◄─────────────────────►単体テスト（UT）
    │   「どう作るか」 ←トレース→ 「正しく動くか」    │
    ▼                                                 ▲
    └──────────────────► 実装 ◄───────────────────────┘
```

---

## 3. 成果物一覧

### 3.1 プロセス成果物

| ID | 成果物 | 格納先 | 説明 |
|----|--------|--------|------|
| PD | プロセス定義書 | docs/process/v-model.md | 本ファイル |
| QG | 品質ゲート定義 | docs/process/quality-gate.md | フェーズ移行条件 |
| TM | トレーサビリティマトリクス | docs/process/traceability.md | 要件↔設計↔テスト対応表 |

### 3.2 V字成果物

| フェーズ | ID | 成果物 | 格納先 | 対応テスト |
|---------|-----|--------|--------|-----------|
| 要件定義 | RD | 要件仕様書 | docs/requirements/RD-xxx.md | ST |
| 基本設計 | BD | 基本設計書 | docs/design/basic/BD-xxx.md | IT |
| 詳細設計 | DD | 詳細設計書 | docs/design/detail/DD-xxx.md | UT |
| テスト | UT | 単体テスト仕様 | docs/test/unit/UT-xxx.md | - |
| テスト | IT | 結合テスト仕様 | docs/test/integration/IT-xxx.md | - |
| テスト | ST | システムテスト仕様 | docs/test/system/ST-xxx.md | - |

### 3.3 ステアリング成果物

| ID | 成果物 | 格納先 | 説明 |
|----|--------|--------|------|
| STEER | ステアリングファイル | docs/steering/STEER-xxx.md | イシュー単位の差分仕様 |

---

## 4. 各フェーズの定義

### 4.1 要件定義（RD）

| 項目 | 内容 |
|------|------|
| 目的 | **何を作るか**を定義する |
| 粒度 | 機能単位・ユースケース単位 |
| 記載内容 | 背景/機能要件/非機能要件/受入条件/スコープ外 |
| 対応テスト | システムテスト（ST） |
| 正本 | docs/requirements/RD-xxx.md |

### 4.2 基本設計（BD）

| 項目 | 内容 |
|------|------|
| 目的 | **どう分けるか**を定義する |
| 粒度 | モジュール単位・I/F単位 |
| 記載内容 | システム構成/モジュール構成/モジュール間I/F/非機能設計方針 |
| 対応テスト | 結合テスト（IT） |
| 正本 | docs/design/basic/BD-xxx.md |

### 4.3 詳細設計（DD）

| 項目 | 内容 |
|------|------|
| 目的 | **どう実装するか**を定義する |
| 粒度 | 関数単位・データ構造単位 |
| 記載内容 | 関数仕様/データ構造/状態遷移/エラー処理 |
| 対応テスト | 単体テスト（UT） |
| 正本 | docs/design/detail/DD-xxx.md |

### 4.4 実装

| 項目 | 内容 |
|------|------|
| 目的 | 詳細設計どおりにコードを書く |
| 成果物 | ソースコード |
| 制約 | DDに記載のない実装は禁止 |

### 4.5 単体テスト（UT）

| 項目 | 内容 |
|------|------|
| 目的 | 詳細設計（DD）どおりに動くか検証する |
| 粒度 | 関数単位 |
| 対象 | DD の各関数/メソッド |

### 4.6 結合テスト（IT）

| 項目 | 内容 |
|------|------|
| 目的 | 基本設計（BD）どおりにモジュールが連携するか検証する |
| 粒度 | モジュール間I/F単位 |
| 対象 | BD のモジュール間I/F |

### 4.7 システムテスト（ST）

| 項目 | 内容 |
|------|------|
| 目的 | 要件定義（RD）どおりにシステムが動くか検証する |
| 粒度 | 要件単位・ユースケース単位 |
| 対象 | RD の各要件・受入条件 |

---

## 5. ステアリング運用フロー

```
1. イシュー起票
       │
       ▼
2. ステアリングファイル作成（Status: Draft）
   └── ストーリー（Why/Who/When）+ 差分仕様（What/How）を記述
       │
       ▼
3. レビュー（Status: Review）
   └── アーキテクト・POが確認
       │
       ▼
4. 承認（Status: Approved）
   └── 実装GOの判断
       │
       ▼
5. 実装
   └── AIはステアリングファイルをコンテキストとして使用
       │
       ▼
6. コードレビュー
       │
       ▼
7. マージ（Status: Merged）
   └── 差分を本体仕様書（RD/DD/UT等）に反映
   └── ステアリングはアーカイブ
```

---

## 6. ガバナンス（段取り）

### 6.1 役割定義

| 役割 | 責務 | 説明 |
|------|------|------|
| 指示者 | 作業の起票・目的の明確化 | PL, PO |
| 作成者 | 仕様/コードの作成 | 担当者, AI |
| レビュアー | 内容の確認・品質担保 | Architect, Senior Dev |
| 承認者 | GO/NO-GO判断 | PL, PO |

### 6.2 RACI マトリクス

| フェーズ | R (実行) | A (説明責任) | C (相談) | I (報告先) |
|---------|---------|-------------|---------|-----------|
| 起票 | PL/PO | PL | Arch | Team |
| 仕様作成（Draft） | 担当者+Claude Code | 担当者 | Arch | PL |
| レビュー | Arch | Arch | - | PL |
| レビュー指摘対応 | 担当者+Codex | 担当者 | Claude Code/Arch | PL |
| 承認 | PL/PO | PL/PO | - | Team |
| 実装 | 担当者+Codex | 担当者 | Arch | PL |
| コードレビュー | CodeRabbit | Arch | - | PL |
| マージ | 担当者 | 担当者 | - | Team |

### 6.3 記録要件

全てのステアリングファイルに以下を記録すること：

1. **起票**: 誰が、いつ、なぜ
2. **作成**: 誰が指示、誰/何が作成（AIモデル名含む）
3. **レビュー**: 誰が、いつ、結果
4. **承認**: 誰が、いつ
5. **実装**: 誰が指示、誰/何が実装
6. **マージ**: 誰が、いつ

---

## 7. AI利用ルール

### 7.1 基本方針

- AIは仕様に忠実に動作する
- 仕様が曖昧だとAIの出力も曖昧になる
- **仕様の品質 = 成果物の品質**

### 7.2 AI利用時の追加要件

| # | 要件 |
|---|------|
| 1 | AIモデル名を記録する（例: claude-opus-4-5-20251101） |
| 2 | 指示内容の概要を記録する |
| 3 | 人間によるレビュー・承認を必須とする（AI単独で完結させない） |
| 4 | AI生成物にはメタ情報を付与する |

### 7.3 AI生成物のメタ情報

```markdown
<!--
  Generated by: [AIモデル名]
  Requested by: @[指示者]
  Date: [日付]
  Instruction: "[指示内容の概要]"
  Reviewed by: @[レビュアー] ([日付])
  Approved by: @[承認者] ([日付])
-->
```

### 7.4 役割分担（Claude Code / Codex）

| 役割 | Claude Code | Codex |
|------|-------------|-------|
| 主担当 | 仕様/ドキュメント | 実装/テスト |
| 出力 | RD/BD/DD/ステアリング | ソースコード |
| コード変更 | しない | する |

---

## 8. コンテキスト最適化

### 8.1 原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | 小さく分割 | 1ドキュメント = 1関心事（100行以下目安） |
| 2 | 明示的に参照 | 「詳細は〇〇を参照」を必ず書く |
| 3 | 階層化 | index → 詳細 の構造 |
| 4 | スコープ限定 | タスクに必要な情報だけ渡す |
| 5 | 正本を明示 | どれが正（Source of Truth）か明記 |

### 8.2 ドキュメント構造

```
docs/
├── process/           # プロセス定義
│   ├── v-model.md
│   ├── quality-gate.md
│   └── traceability.md
├── requirements/      # 要件仕様書
│   ├── index.md
│   └── RD-xxx.md
├── design/           # 設計書
│   ├── index.md
│   ├── basic/
│   │   └── BD-xxx.md
│   └── detail/
│       └── DD-xxx.md
├── test/             # テスト仕様書
│   ├── plan.md
│   ├── unit/
│   ├── integration/
│   └── system/
├── steering/         # ステアリング（差分仕様）
│   ├── TEMPLATE.md
│   └── STEER-xxx.md
└── archive/          # 旧ドキュメント
```

---

## 9. 参照ドキュメント

| ドキュメント | 説明 |
|-------------|------|
| [品質ゲート定義](quality-gate.md) | フェーズ移行条件 |
| [トレーサビリティマトリクス](traceability.md) | 要件↔設計↔テスト対応表 |
| [ステアリングテンプレート](../steering/TEMPLATE.md) | 差分仕様のテンプレート |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2026-01-30 | 1.0 | 初版作成 | @MasanoriSuda + Claude Code |
