<!-- SOURCE_OF_TRUTH: プロダクト要求仕様書 -->
# プロダクト要求仕様書（PRD）

> Virtual Voicebot Backend のプロダクト要求を定義する

---

## 1. プロダクトビジョンと目的

### 1.1 ビジョン
**Virtual Voicebot** は、SIP/RTP ベースの音声対話ボットシステムである。電話（SIP）で着信し、AI（ASR/LLM/TTS）を活用してユーザーと自然な対話を行い、通話履歴と録音を提供する。

### 1.2 目的
- **業務効率化**: 顧客からの問い合わせを AI ボットが一次対応し、オペレーター負荷を軽減
- **24時間対応**: 人手を介さず常時対応可能な窓口を提供
- **通話記録管理**: 録音と要約により、後から内容を確認・分析可能にする

### 1.3 スコープ（MVP）
- SIP UAS として着信を受け、音声対話を実施
- 通話終了後に履歴と録音を Frontend へ連携
- ライブ中継・逐次発話表示は対象外（将来検討）

---

## 2. ターゲットユーザーと課題、ニーズ

### 2.1 ターゲットユーザー

| ユーザー | 説明 |
|---------|------|
| **エンドユーザー（発信者）** | 電話で問い合わせを行う顧客。SIP クライアント（Zoiper 等）を使用 |
| **オペレーター/管理者** | 通話履歴・録音を確認し、対応品質を管理する社内担当者 |
| **システム管理者** | ボットの設定・監視・運用を行う技術担当者 |

### 2.2 課題とニーズ

| 課題 | ニーズ |
|------|-------|
| 問い合わせ対応に人手がかかる | AI による自動応答で初期対応を省力化したい |
| 営業時間外は対応できない | 24時間いつでも受付可能にしたい |
| 通話内容の振り返りが困難 | 録音と要約で後から確認したい |
| 対応品質のばらつき | 一貫した応答品質を担保したい |

---

## 3. 主要な機能一覧

### 3.1 MVP 機能

| # | 機能 | 説明 | 参照 |
|---|------|------|------|
| F-1 | SIP 着信処理 | INVITE → 100/180/200 → ACK → BYE の基本フロー | design.md §2 |
| F-2 | RTP 音声処理 | PCMU/8000 の送受信、簡易ジッタバッファ | rtp.md |
| F-3 | 音声認識（ASR） | ユーザー発話をテキスト化 | ai.md §2 |
| F-4 | 対話生成（LLM） | テキストから応答を生成 | ai.md §3 |
| F-5 | 音声合成（TTS） | 応答テキストを音声化 | ai.md §4 |
| F-6 | 録音保存 | mixed.wav + meta.json を生成 | recording.md |
| F-7 | 録音配信 | HTTP で録音ファイルを配信（Range 対応） | contract.md |
| F-8 | 履歴連携 | 通話終了時に ingest API で Frontend へ通知 | contract.md |

### 3.2 拡張機能（Future）

| # | 機能 | 説明 |
|---|------|------|
| F-9 | 100rel/PRACK | RFC 3262 準拠の信頼性確保 |
| F-10 | Session Timer | RFC 4028 準拠のセッション維持 |
| F-11 | DTMF 検出 | プッシュボタン入力対応 |
| F-12 | Digest 認証 | SIP 認証対応 |
| F-13 | UAC 発信 | ボット側からの発信機能 |

---

## 4. 成功の定義

### 4.1 MVP 成功基準

| # | 指標 | 目標値 | 計測方法 |
|---|------|--------|---------|
| S-1 | 基本着信成功率 | 99%+ | INVITE → 200 OK → ACK 成功率 |
| S-2 | 対話完了率 | 95%+ | ASR/LLM/TTS がすべて成功した通話の割合 |
| S-3 | 録音生成率 | 100% | 終話時に mixed.wav が生成される割合 |
| S-4 | 履歴連携成功率 | 99%+ | ingest API 呼び出し成功率 |

### 4.2 品質指標

| # | 指標 | 目標値 |
|---|------|--------|
| Q-1 | 応答遅延（ASR+LLM+TTS） | 3秒以内（P95） |
| Q-2 | RTP パケットロス | 1%未満 |
| Q-3 | エラー時のフォールバック | 謝罪音声再生 + 継続 or 終了 |

---

## 5. ユーザーストーリー

### 5.1 エンドユーザー（発信者）

```
US-1: 電話をかけて問い合わせる
  As a 発信者
  I want to ボットに電話して質問する
  So that 必要な情報を得られる

  受入条件:
  - 電話がつながり、ボットが応答する
  - 質問に対して適切な回答が返る
  - 通話を終了できる
```

```
US-2: 聞き取れなかった場合の再確認
  As a 発信者
  I want to ボットが聞き取れなかった時に再度話せる
  So that 正しく伝わるまでやり取りできる

  受入条件:
  - ASR 失敗時に「もう一度お願いします」と言われる
  - 連続失敗でも通話が即切断されない（1回目）
```

### 5.2 オペレーター/管理者

```
US-3: 通話履歴を確認する
  As a オペレーター
  I want to 過去の通話一覧と録音を確認する
  So that 対応内容を把握・改善できる

  受入条件:
  - 通話終了後に履歴が Frontend に表示される
  - 録音をブラウザで再生できる（シーク可能）
  - 要約が表示される
```

### 5.3 システム管理者

```
US-4: ボットの稼働状況を監視する
  As a システム管理者
  I want to ログとメトリクスで稼働状況を確認する
  So that 問題を早期発見・対処できる

  受入条件:
  - SIP/RTP/AI のログが出力される
  - エラー発生時に警告ログが出る
```

---

## 6. 機能要件

### 6.1 SIP/RTP

| ID | 要件 | 優先度 |
|----|------|:------:|
| FR-1 | INVITE 受信で 100/180/200 を返す | P0 |
| FR-2 | ACK 受信でメディアセッション確立 | P0 |
| FR-3 | BYE 受信で 200 を返し通話終了 | P0 |
| FR-4 | RTP (PCMU/8000) の送受信 | P0 |
| FR-5 | CANCEL 受信で 487 を返す | P0 |
| FR-6 | 100rel/PRACK 対応 | P1 |
| FR-7 | Session Timer 対応 | P1 |

### 6.2 AI 連携

| ID | 要件 | 優先度 |
|----|------|:------:|
| FR-10 | ASR で音声をテキスト化 | P0 |
| FR-11 | LLM でテキスト応答を生成 | P0 |
| FR-12 | TTS で応答を音声化 | P0 |
| FR-13 | ASR/LLM/TTS 失敗時のフォールバック | P0 |
| FR-14 | 連続失敗時の終話判断（config 管理、既定: 2回） | P0 |

### 6.3 録音・履歴

| ID | 要件 | 優先度 |
|----|------|:------:|
| FR-20 | 通話音声を mixed.wav で保存 | P0 |
| FR-21 | meta.json でメタデータ保存 | P0 |
| FR-22 | HTTP で録音配信（Range 対応） | P0 |
| FR-23 | 通話終了時に ingest API で Frontend へ通知 | P0 |

---

## 7. 非機能要件

### 7.1 性能

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-1 | 同時通話数 | 10+ |
| NFR-2 | 応答遅延（E2E） | 3秒以内（P95） |
| NFR-3 | RTP 処理遅延 | 100ms以内 |

### 7.2 可用性

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-10 | サービス稼働率 | 99.9%（年間停止8.76時間以内） |
| NFR-11 | 障害復旧時間 | 10分以内 |

### 7.3 セキュリティ

| ID | 要件 | 備考 |
|----|------|------|
| NFR-20 | PII 保護 | 音声・文字起こし・LLM 入出力は PII として扱う |
| NFR-21 | ログマスキング | 原文全文をログに出さない |
| NFR-22 | 認証 | MVP はなし。将来 Bearer トークン等を検討 |

### 7.4 運用性

| ID | 要件 | 備考 |
|----|------|------|
| NFR-30 | ログ出力 | SIP/RTP/AI 各層で構造化ログ |
| NFR-31 | 相関ID | 全ログに `call_id` を付与 |
| NFR-32 | メトリクス | 応答コード数、エラー件数、遅延等 |

---

## 8. 受け入れ条件と優先順位

### 8.1 優先順位定義

| 優先度 | 説明 |
|:------:|------|
| P0 | MVP 必須。これがないとリリースできない |
| P1 | MVP 後の最優先。早期に対応が必要 |
| P2 | 将来対応。必要性が確認されたら着手 |
| Deferred | 保留。仕様策定後に再検討 |

### 8.2 受け入れ条件（AC）サマリー

詳細は [tests.md](tests.md) を参照。

| AC | 内容 | 優先度 | 状態 |
|----|------|:------:|------|
| AC-1 | 基本着信フロー（INVITE→ACK→BYE） | P0 | 実装済み |
| AC-2 | 100rel/PRACK | P1 | 実装済み |
| AC-3 | Session Timer | P1 | 実装済み |
| AC-4 | CANCEL 処理 | P0 | 未実装 |
| AC-5 | DTMF トーン検出 | P0 | 未実装 |
| AC-6 | Digest 認証 | Deferred | - |
| AC-7 | UAC 発信 | Deferred | - |
| AC-8 | HTTP Range 対応 | P0 | 未実装 |

---

## 9. 参照ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [design.md](design.md) | アーキテクチャ設計（正本） |
| [app.md](app.md) | App 層 I/F（正本） |
| [ai.md](ai.md) | AI 連携 I/F（正本） |
| [tests.md](tests.md) | テスト計画・AC（正本） |
| [contract.md](../../docs/contract.md) | Frontend ↔ Backend API 契約 |
| [recording.md](recording.md) | 録音設計 |
| [gap-analysis.md](gap-analysis.md) | RFC 準拠ギャップ分析 |
