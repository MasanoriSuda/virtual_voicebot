# ステアリング運用ガイド

> ステアリング（差分仕様）の作成・運用に関する実践ガイド

| 項目 | 値 |
|------|-----|
| ステータス | Active |
| 作成日 | 2026-02-01 |
| 関連 | [v-model.md §5](../process/v-model.md) |

---

## 1. いつステアリングを作るか（トリガー）

### 1.1 必須（MUST）

以下のいずれかに該当する場合、ステアリングを作成する：

| トリガー | 例 |
|---------|-----|
| **アーキテクチャ変更** | レイヤー構造変更、新パターン導入 |
| **複数ファイル（3+）に影響** | リファクタリング、API 変更 |
| **破壊的変更** | 既存 API の削除・非互換変更 |
| **新規機能（中規模以上）** | 新しいポート追加、新エンティティ |
| **外部挙動が変わるバグ修正** | API レスポンス変更、エラーコード変更 |

### 1.2 推奨（SHOULD）

| トリガー | 例 |
|---------|-----|
| **設計判断が必要** | 複数の実装方針から選択 |
| **他チームへの影響** | Frontend/Infrastructure への依存 |
| **段階的実装** | Phase 分けが必要な変更 |

### 1.3 不要（MAY SKIP）

| ケース | 理由 |
|--------|------|
| バグ修正（1-2ファイル、内部挙動のみ） | 既存仕様の範囲内 |
| ドキュメント修正のみ | コード変更なし |
| 依存ライブラリ更新（minor） | 影響が限定的 |

> **注意**: 外から見える挙動が変わるバグ修正（API レスポンス変更等）は §1.1 MUST に該当する。

---

## 2. ID 採番ルール

### 2.1 基本ルール

```
STEER-{イシュー番号:3桁ゼロ埋め}_{slug}.md
```

| 項目 | ルール |
|------|--------|
| イシュー番号 | **実装チケット**の Issue 番号を 3 桁ゼロ埋めで使用 |
| slug | 英小文字、ハイフン区切り、内容を表す短い名前 |

### 2.2 複数 Issue が関連する場合

- **主となる実装 Issue** の番号を採用
- 関連 Issue は本文の「関連Issue」欄に列挙

```markdown
| 関連Issue | #52, #65, #85 |
```

### 2.3 例

| Issue 状況 | ステアリング ID |
|-----------|----------------|
| Issue #85 で実装予定 | `STEER-085_xxx.md` |
| Issue #7 で実装予定 | `STEER-007_xxx.md` |
| #52, #65 の議論 → #85 で実装 | `STEER-085_xxx.md`（関連Issue: #52, #65, #85） |

### 2.4 index.md 必須カラム

ステアリング作成時は [index.md](index.md) に以下のカラムを記載すること：

| カラム | 必須 | 説明 |
|--------|------|------|
| ID | ◎ | `[STEER-xxx](ファイル名.md)` 形式のリンク |
| タイトル | ◎ | 簡潔な変更名称 |
| ステータス | ◎ | Draft / Review / Approved / Merged |
| 関連Issue | ◎ | `#xxx, #yyy` 形式 |
| 優先度 | ○ | P0 / P1 / P2 |
| 概要 | ○ | 1行で変更内容を要約 |
| Owner | △ | 作成者（省略時はステアリング本文参照） |
| Created | △ | 作成日（省略時はステアリング本文参照） |

凡例: ◎=必須、○=推奨、△=任意

---

## 3. 作成手順（チェックリスト）

### 3.0 前提条件（ガードレール）

> **作業開始前に必ず確認すること**

| 条件 | 確認方法 | NG時の対応 |
|------|---------|-----------|
| GitHub Issue が存在する | Issue 番号を確認 | Issue を先に作成 |
| 作業ブランチが切られている | `git branch --show-current` | ブランチを作成 |
| 作業ブランチにチェックアウト済み | 同上 | `git checkout` で切り替え |

**ブランチ命名規則**:

```
feat/{issue番号}-{slug}
fix/{issue番号}-{slug}
refactor/{issue番号}-{slug}
docs/{issue番号}-{slug}

例:
- feat/85-clean-architecture
- fix/92-null-pointer
- docs/100-api-reference
```

**プレフィックス選択基準**:

| プレフィックス | 使用条件 | 例 |
|--------------|---------|-----|
| `feat/` | **コード変更あり** + 新機能・機能追加 | feat/85-clean-architecture |
| `fix/` | **コード変更あり** + バグ修正 | fix/92-null-pointer |
| `refactor/` | **コード変更あり** + リファクタリング（挙動変更なし） | refactor/100-module-split |
| `docs/` | **コード変更なし** + ドキュメントのみ | docs/89-frontend-requirements |

```
判定フロー:

コード変更あり？
  ├─ Yes → 新機能？ → feat/
  │        バグ修正？ → fix/
  │        リファクタ？ → refactor/
  └─ No  → docs/
```

> **注意**: 仕様書（RD/BD/DD）のみの変更でも、それが将来コード変更を伴う場合は `feat/` を使用することもある。
> 判断に迷う場合は `feat/` を選択（より包括的なため）。

```bash
# ブランチ確認コマンド
git branch --show-current

# 期待される出力例: feat/85-clean-architecture
# NG例: main, develop, master
```

> **ガードレール**: `main` / `develop` / `master` ブランチで作業を開始してはいけない。
> 必ず `feat/xxx-*` 等の作業ブランチに切り替えてから作業を開始すること。

---

### 3.1 起票フェーズ

- [ ] GitHub Issue が存在する（なければ先に作成）
- [ ] Issue に要件・背景が記載されている
- [ ] **作業ブランチが作成・チェックアウト済み**（§3.0 参照）

### 3.2 作成フェーズ

```bash
# 0. ブランチ確認（main/develop でないことを確認）
git branch --show-current
# → feat/85-clean-architecture などであること

# 1. テンプレートをコピー（Issue番号は3桁ゼロ埋め）
cp docs/steering/TEMPLATE.md docs/steering/STEER-085_example.md

# 2. メタ情報を埋める
# 3. ストーリー（Why/Who/When）を記述
# 4. 差分仕様（What/How）を記述
```

- [ ] **ブランチが作業ブランチであることを確認**
- [ ] テンプレートからファイル作成（3桁ゼロ埋め）
- [ ] メタ情報（ID, タイトル, 関連Issue）を記入
- [ ] §2 ストーリー（背景・目的・ユーザーストーリー）を記述
- [ ] §3 段取り（起票者・作成者）を記入
- [ ] §4 影響範囲を特定
- [ ] §6 差分仕様を記述
- [ ] §10 受入条件を定義
- [ ] index.md に追加（§2.4 の必須カラムを満たす）

### 3.3 レビューフェーズ

- [ ] ステータスを `Review` に変更
- [ ] レビュアーを §3.3 に記入
- [ ] レビュー指摘を反映

### 3.4 承認フェーズ

- [ ] ステータスを `Approved` に変更
- [ ] 承認者・承認日を §3.4 に記入
- [ ] **仕様確定**（実装 GO）の判断完了

---

## 4. ステータス遷移条件

### 4.0 ステータス定義

| ステータス | 意味 | 説明 |
|-----------|------|------|
| **Draft** | 作成中 | 仕様策定中、レビュー未依頼 |
| **Review** | レビュー中 | レビュアーによる確認中 |
| **Approved** | 仕様確定 | 仕様が承認済み、実装可能 |
| **Merged** | 本体反映済み | 本体仕様書（RD/DD/UT）へ反映完了 |

### 4.1 遷移フロー

```
Draft ──────────────────→ Review ─────────────────→ Approved ─────────────────→ Merged
      (作成完了・自己確認)       (レビュー承認)            (実装完了・本体反映)
                                                    ↓
                                              仕様確定済み
                                              実装開始可能
```

### 4.2 Draft → Review

| 条件 | 確認者 |
|------|--------|
| ストーリー（Why）が明確 | 作成者 |
| 差分仕様が具体的（コード例あり） | 作成者 |
| 受入条件が検証可能 | 作成者 |
| 影響範囲が特定済み | 作成者 |

### 4.3 Review → Approved

| 条件 | 確認者 |
|------|--------|
| アーキテクチャ観点 OK | Architect |
| 要件との整合性 OK | PO |
| 実装可能性 OK | Tech Lead |
| レビュー指摘がすべて解決 | レビュアー |

> **最小構成**: 小規模変更（P1以下）では、Architect / PO / Tech Lead の兼任可。
> 最低 1 名の承認者が上記 3 観点すべてを確認すれば Approved に遷移可能。

### 4.4 Approved → Merged

| 条件 | 確認者 |
|------|--------|
| 実装 PR がマージ済み | 実装者 |
| 受入条件がすべて完了 | PO |
| 本体仕様書（RD/DD/UT）に反映済み | 作成者 |

### 4.5 滞留時ルール（SLA）

| 状況 | 対応 |
|------|------|
| Review で **3 営業日**反応なし | 作成者がレビュアーにリマインド |
| Review で **5 営業日**反応なし | PO / Tech Lead にエスカレーション |
| Approved で **10 営業日**実装未着手 | 優先度再確認、必要に応じて Backlog へ |

---

## 5. AI エージェントの役割分担

### 5.1 役割マトリクス

| フェーズ | Claude Code | Codex | CodeRabbit | 人間 |
|---------|-------------|-------|------------|------|
| ステアリング作成 | **主担当** | - | - | 指示・レビュー |
| 仕様レビュー | 矛盾検出・質問 | 実装観点コメント | - | 承認 |
| 実装 | - | **主担当** | - | 指示 |
| コードレビュー | - | - | **主担当** | 確認・承認 |
| 本体仕様書マージ | **主担当** | - | - | 確認 |

### 5.2 Claude Code の責務

- ステアリングファイルの作成・更新
- ドキュメント間の整合性チェック
- 本体仕様書（RD/DD/UT）への反映
- **コード変更はしない**

### 5.3 Codex の責務

- ステアリングに基づく実装
- テストコードの作成
- **仕様の作成・変更はしない**（提案は可）
- **コードレビューは CodeRabbit に委譲**

### 5.4 CodeRabbit の責務

- PR のコードレビュー（自動実行）
- コード品質・セキュリティ・パフォーマンス観点の指摘
- 既存コードとの整合性チェック
- **実装・仕様変更はしない**（指摘のみ）

### 5.5 引き継ぎ方法

**Claude Code → Codex（実装依頼）**:

```markdown
## Codex への引き継ぎ

ステアリング [STEER-085](docs/steering/STEER-085_clean-architecture.md) に基づき実装してください。

Refs #85
```

**Codex → Claude Code（仕様修正提案）**:

```markdown
## Claude Code への提案

実装中に以下の仕様不足を発見しました：
- [具体的な指摘]

ステアリングの修正を提案します。

Refs #85
```

---

## 6. 本体仕様書へのマージ方法

### 6.1 マージタイミング

| タイミング | 条件 | 備考 |
|-----------|------|------|
| **実装完了後**（推奨） | 受入条件がすべて満たされた | 実装で判明した調整を反映できる |
| **Approved 直後** | 仕様が確定し変更見込みが低い | 早期に本体を更新したい場合 |

> **注意**: Approved 後にマージする場合、実装時の差分が発生したら本体仕様書も再更新すること。

### 6.2 マージ対象

| ステアリング内容 | マージ先 |
|-----------------|---------|
| 要件の追加・変更 | RD-xxx |
| 基本設計の追加・変更 | BD-xxx |
| 詳細設計の追加・変更 | DD-xxx |
| テスト仕様の追加・変更 | UT-xxx / IT-xxx |

### 6.3 マージ方法

**デフォルト方針: 差分コピー**

1. **差分コピー**（原則）: ステアリングの該当セクションを本体にコピー
2. **参照追加**: 本体に「STEER-xxx より追加」と出典を記載
3. **ステアリング更新**: ステータスを `Merged` に変更
4. **index.md 更新**: ステータスを反映

> **例外（参照のみ）**: 本体が肥大化する場合や、頻繁に更新される仕様は「詳細は STEER-xxx 参照」として本体には概要のみ記載可。ただし、承認者の判断を得ること。

### 6.4 マージ後のステアリング

- **削除しない**（履歴として保持）
- ステータスを `Merged` に変更
- 必要に応じてアーカイブディレクトリへ移動

---

## 7. よくある質問（FAQ）

### Q1: 小さな変更でもステアリングが必要？

**A**: §1.3 の「不要」条件に該当すればスキップ可。ただし外部挙動が変わる場合は §1.1 MUST。迷ったら作成を推奨。

### Q2: 途中で仕様が変わったら？

**A**: ステアリングを更新し、変更履歴に記録。大きな変更は新規ステアリングを検討。

### Q3: 複数のステアリングが同じ領域に影響する場合は？

**A**: 依存関係を明記し、実装順序を決定。必要なら統合ステアリングを作成。

### Q4: Codex が仕様の問題を見つけたら？

**A**: §5.4 の引き継ぎ方法で Claude Code に提案。勝手に仕様を変更しない。

### Q5: 本体仕様書とステアリングが矛盾したら？

**A**: 以下の手順で解決する：

1. **Approved 済みのステアリング**を優先（最新の承認済み決定）
2. 両方 Approved の場合は**承認者（PO / Architect）が裁定**
3. **矛盾を解消してから**実装に進む（曖昧なまま実装しない）

> 矛盾発見時は、どちらが正しいか判断せず、まず承認者に報告すること。

### Q6: main ブランチで作業を始めてしまったら？

**A**: 以下の手順でリカバリする：

```bash
# 1. 変更を一時退避
git stash

# 2. 作業ブランチを作成・切り替え
git checkout -b feat/85-clean-architecture

# 3. 退避した変更を復元
git stash pop
```

> **予防策**: 作業開始時に必ず `git branch --show-current` でブランチを確認する習慣をつける。

---

## 8. 参照

| ドキュメント | 内容 |
|-------------|------|
| [v-model.md §5](../process/v-model.md) | ステアリング運用フロー（プロセス定義） |
| [v-model.md §6](../process/v-model.md) | ガバナンス（RACI マトリクス） |
| [TEMPLATE.md](TEMPLATE.md) | ステアリングテンプレート |
| [index.md](index.md) | ステアリング一覧 |
| [CLAUDE.md](../../../CLAUDE.md) | Claude Code の役割定義 |
| [AGENTS.md](../../AGENTS.md) | Codex の役割定義 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2026-02-01 | 0.1 | 初版ドラフト作成 | Claude Code |
| 2026-02-01 | 0.2 | 運用開始品質へ整備 | Claude Code |
| 2026-02-01 | 0.3 | ブランチ確認ガードレール追加 | Claude Code |
| 2026-02-01 | 0.4 | CodeRabbit をコードレビュー担当として追加 | Claude Code |
| 2026-02-02 | 0.5 | ブランチプレフィックス選択基準を追加 | Claude Code |

### 変更履歴（0.2）

- §1.1: 「外部挙動が変わるバグ修正」を MUST トリガーに追加
- §1.3: 「内部挙動のみ」の条件を明確化、注意書き追加
- §2.1: ID 採番を「3桁ゼロ埋め」に統一（例: STEER-085, STEER-007）
- §2.3: 例を 3 桁ゼロ埋めに修正
- §2.4: index.md 必須カラムを新設（ID/タイトル/ステータス/関連Issue 等）
- §3.2: チェックリストに「3桁ゼロ埋め」を明記
- §4.0: ステータス定義を新設（Approved=仕様確定、Merged=本体反映済み）
- §4.1: 遷移フロー図に「仕様確定済み/実装開始可能」を追記
- §4.3: 最小構成/兼任可のルールを追記（小規模変更時）
- §4.5: 滞留時ルール（SLA）を新設（3営業日リマインド、5営業日エスカレーション）
- §6.1: Approved 後マージ時の注意事項を追記
- §6.3: デフォルト方針「差分コピー」を明記、参照のみは例外と規定
- §7 Q1: 外部挙動変更時は MUST である旨を追記
- §7 Q5: 「ステアリングが正」を「承認済み優先＋承認者裁定＋統一してから進む」に修正
- ステータスを Draft → Active に変更

### 変更履歴（0.3）

- §3.0: 前提条件（ガードレール）を新設
  - ブランチ命名規則（feat/fix/refactor/docs）を定義
  - main/develop/master での作業開始を禁止
  - ブランチ確認コマンド例を追加
- §3.1: 「作業ブランチが作成・チェックアウト済み」をチェック項目に追加
- §3.2: ブランチ確認コマンドをコード例に追加
- §7 Q6: main ブランチで作業を始めた場合のリカバリ手順を追加

### 変更履歴（0.4）

- §5: タイトルを「Claude Code / Codex の役割分担」→「AI エージェントの役割分担」に変更
- §5.1: 役割マトリクスに CodeRabbit 列を追加（コードレビュー担当）
- §5.3: Codex の責務から「実装観点からのレビューコメント」を削除、「コードレビューは CodeRabbit に委譲」を追加
- §5.4: CodeRabbit の責務を新設
- §5.5: 引き継ぎ方法（旧 §5.4）のセクション番号を更新

### 変更履歴（0.5）

- §3.0: ブランチプレフィックス選択基準を追加
  - feat/fix/refactor/docs の使い分け条件を明記
  - 判定フローを追加（コード変更有無で分岐）
  - 迷った場合は feat/ を推奨する注意書きを追加

