# Review: Issue #8 - アーキテクチャ改善計画 (PLAN.md)

**日付**: 2025-12-30
**レビュアー**: Codex
**対象**: `virtual-voicebot-backend/docs/impl/PLAN.md`

---

## 指摘事項

### 中: ARCH-01〜05 が Plan 原則と不整合

**根拠**: PLAN.md:21-25, 127-194

ARCH-01〜05 が実施項目として追加された一方で、Plan の「Spec変更が必要なものは Deferred Steps へ分離」「各 Step に DoD」ルールに沿った配置/DoD がなく、運用ルールと整合していません。

**対応**:
```diff
 ## Architecture Improvements（アーキテクチャ改善）

+> ※設計/仕様変更を伴うため、各 ARCH は Spec 策定後に Step 化（Deferred Steps 扱い）する。
```

### 軽: ARCH-01/05 の対象ファイル記載が不足

**根拠**: PLAN.md:140-190

ARCH-01/05 の対象ファイルが外部I/O・設定依存の実体とズレており、スコープ誤認の恐れがあります。

**対応**:
```diff
-**対象ファイル**: `src/ai/mod.rs`, `src/ai/*.rs`, `src/session/session.rs`
+**対象ファイル**: `src/ai/mod.rs`, `src/ai/*.rs`, `src/http/mod.rs`, `src/recording/mod.rs`, `src/session/session.rs`
```

```diff
-**対象ファイル**: `src/config.rs`, `src/sip/mod.rs`, `src/main.rs`
+**対象ファイル**: `src/config.rs`, `src/sip/mod.rs`, `src/main.rs`, `src/ai/*.rs`
```

---

## Open Question

ARCH-01〜05 はこのままエピック扱いで、後日 Step 化する前提で良いですか？

**回答**: Yes - Deferred Steps 扱いとして注記を追加済み。Spec 策定後に個別 Step 化する。

---

## PR 本文要約

- 中: ARCH-01〜05 が Deferred/Step 化されておらず Plan 原則と不整合（PLAN.md:21-25, 127-194）
- 軽: ARCH-01/05 の対象ファイル記載が不足（PLAN.md:140-190）

---

## 第2回レビュー（2025-12-30）

### 中: ARCH-01a/02/03 の記述が実装と不一致

**ARCH-01a**:
- 根拠: PLAN.md:152, 161 と `ai.rs` (line 15), `mod.rs` (line 221, 10) が齟齬
- 対応: 対象/変更内容を `AiPort`（ai.rs）と `mod.rs` 依存に修正

**ARCH-02**:
- 根拠: PLAN.md:189 と `types.rs` (line 135), `mod.rs` (line 328)
- 対応: 対象ファイルを `types.rs` に修正、状態を「一部完了」に変更

**ARCH-03**:
- 根拠: PLAN.md:199 と `timers.rs` (line 7), `capture.rs` (line 3), `session.rs` (line 60)
- 対応: 分割案を `SessionTimers`/`AudioCapture` に合わせ、未対応分を TODO として記載

### 軽: 対象ファイル/根拠の不一致

**ARCH-01b/01c**:
- 根拠: PLAN.md:169, 181 と `ingest.rs` (line 1), `storage.rs` (line 1)
- 対応: 対象ファイルに新規モジュールを追加

**CQ-02**:
- 根拠: PLAN.md:269, 271 - `mod.rs` には該当なし、`writing.rs` が存在しない
- 対応: 根拠と対象ファイルを `session/mod.rs` 等に差し替え

**ARCH-04**:
- 根拠: PLAN.md:215 - DI 組み立ては `main.rs`/`session/*` 側
- 対応: 対象ファイルを実態に合わせる

## PR 本文要約（第2回）

- 中: 3（ARCH-01a/02/03 の記述が実装と不一致）
- 軽: 3（ARCH-01b/01c 対象ファイル漏れ、CQ-02 参照不一致、ARCH-04 対象ファイル不一致）

---

## 第3回レビュー（2025-12-30）

### 中: ARCH-04 対象ファイルパス不存在

**根拠**: PLAN.md:221 - `src/rtp/writing.rs` が存在しない

**対応**:
```diff
-**対象ファイル**: `src/main.rs` (line 101), `src/session/session.rs` (line 68), `src/rtp/writing.rs` (line 15)
+**対象ファイル**: `src/main.rs` (line 101), `src/session/session.rs` (line 68), `src/session/writing.rs` (line 15)
```

### 軽: CQ-02 根拠の不一致

**根拠**: PLAN.md:271 - `session/mod.rs` (line 8) に unbounded_channel 使用なし

**対応**:
```diff
-**根拠**: `src/session/mod.rs` (line 8), `src/session/session.rs` (line 82), `src/main.rs` (line 43)
+**根拠**: `src/main.rs` (line 18, 43-48), `src/session/session.rs` (line 82)
```

### 軽: ARCH-03 AudioCapture 説明の不適切さ

**根拠**: PLAN.md:205 - `AudioCapture` は「録音制御」ではなく「音声キャプチャ/バッファ」が適切

**対応**:
```diff
-- `AudioCapture`: 録音制御（`src/session/capture.rs` line 3）
+- `AudioCapture`: 音声キャプチャ/バッファ（`src/session/capture.rs` line 3）
```

## PR 本文要約（第3回）

- 中: 1（ARCH-04 対象ファイルパス不存在）
- 軽: 2（CQ-02 根拠不一致、ARCH-03 説明不適切）
