# ワークスペース整合性レビュー結果

**Refs**: Issue #7
**レビュー日**: 2025-12-27
**担当**: Claude Code（仕様/ドキュメント観点）
**対象**: ルール/ドキュメント/実装の矛盾洗い出し

---

## 概要

GitHub Issue #7「ワークスペース全体レビュー（Claude + Codex）」に基づき、Claude Code がドキュメント/仕様整合性の観点からレビューを実施しました。

---

## 指摘一覧

### 🔴 重大（整合性エラー）

| # | 指摘 | 根拠 | 修正案 |
|---|------|------|--------|
| C-1 | **AGENTS.md の重複と役割不明確** | ルート `/AGENTS.md`（24行）と `/virtual-voicebot-backend/AGENTS.md`（181行）が併存。DOCS_POLICY.md §3.3 は backend のみを正本と定義するが、ルートにも実質的なルールが存在 | 下記「修正案C-1」参照 |
| C-2 | **src/rtp/README.md が実態と乖離** | README.md に「rtp モジュールへの委譲は**未着手**」と記載（7行）。しかし `docs/rtp.md`（143行）には実装済み詳細が記載。DOCS_ANALYSIS.md §1.3 で既に指摘済みだが未修正 | README.md を更新し、`docs/rtp.md` へリンク |
| C-3 | **gap-analysis.md の Last Updated 不一致** | ファイルヘッダに `Last Updated: 2025-12-25` と記載されているが、2025-12-27 に UAS優先更新を実施済み | 日付を `2025-12-27` に更新 |

---

### 🟡 中（運用リスク）

| # | 指摘 | 根拠 | 修正案 |
|---|------|------|--------|
| M-1 | **CLAUDE.md と AGENTS.md のレビュー観点重複** | CLAUDE.md §追加：レビュー任務とルート AGENTS.md §追加：レビュー任務が同じ「レビュー出力フォーマット（必須）」を定義。Claude/Codex の責務分担が曖昧 | 下記「修正案M-1」参照 |
| M-2 | **DOCS_INDEX.md に impl/ が未掲載** | `docs/impl/PLAN.md` および `docs/impl/TODO.md` が存在するが、DOCS_INDEX.md に記載なし | DOCS_INDEX.md に impl/ セクション追加 |
| M-3 | **DOCS_POLICY.md の階層図と実態の不一致** | §2 の階層図で AGENTS.md は `virtual-voicebot-backend/` 配下のみ記載。しかしルートにも AGENTS.md が存在（§3.3 正本一覧にも未記載） | 階層図を更新、または ルート AGENTS.md の扱いを明確化 |
| M-4 | **current-spec.md が空ファイルのまま残存** | `virtual-voicebot-backend/docs/current-spec.md`（0バイト）。DOCS_ANALYSIS.md §2.5 で「削除」提案済みだが未実施 | 削除 |
| M-5 | **backend AGENTS.md §10 と tests_e2e_sipp.md の重複** | SIPp 実行手順が両方に記載（DOCS_ANALYSIS.md §1.4 で既に指摘済み） | AGENTS.md §10 を要約に絞り、`docs/tests_e2e_sipp.md` へリンク |

---

### 🟢 軽（改善推奨）

| # | 指摘 | 根拠 | 修正案 |
|---|------|------|--------|
| L-1 | **DOCS_ANALYSIS.md の「完了済み作業」が不完全** | §5 に `2025-12-25 todo*.md 削除` のみ記載。UAS優先更新（2025-12-27）が未反映 | 作業履歴を追記 |
| L-2 | **design.md の参照が古い可能性** | §2.3 未決事項に「UASのみで運用する前提で良いか」とあるが、gap-analysis.md では「UAS優先」方針が確定済み | 未決事項を更新（確定事項に移行） |
| L-3 | **http/media/ai モジュール README の詳細度不足** | src/http/README.md, src/media/README.md が docs/*.md へのリンクを持つか未確認 | 各 README に docs/*.md へのリンク追加 |

---

## 修正案

### 修正案 C-1: AGENTS.md 重複解消

**選択肢A（推奨）**: ルート AGENTS.md を「共通ルール + backend 参照」に限定

```markdown
# AGENTS.md (repo root)

## 適用範囲
本ファイルはリポジトリ全体に適用される共通ルールを定義します。
Backend 固有の詳細は [virtual-voicebot-backend/AGENTS.md](virtual-voicebot-backend/AGENTS.md) を参照してください。

## 0. 合意（チケット）ゲート（必須）
（現行のまま維持）

## ドキュメント更新の扱い（必須）
（現行のまま維持）

## レビュー任務
- Claude Code: 仕様/ドキュメント整合性（詳細は /CLAUDE.md）
- Codex: 実装/テスト観点（詳細は /virtual-voicebot-backend/AGENTS.md）
```

**選択肢B**: ルート AGENTS.md を削除し、backend AGENTS.md に統合

---

### 修正案 M-1: レビュー責務の明確化

**CLAUDE.md** に以下を追記:

```markdown
## Claude Code と Codex の責務分担

| 観点 | Claude Code | Codex |
|------|-------------|-------|
| **主担当** | 仕様/ドキュメント整合性 | 実装/テスト観点 |
| **レビュー対象** | docs 矛盾、V字トレース、運用観点 | 依存方向、非同期境界、timeout/backpressure |
| **出力** | 仕様修正案、質問リスト | 最小差分コード修正案 |
| **コード変更** | ❌ しない | ✓ する |
```

---

### 修正案 M-2: DOCS_INDEX.md に impl/ 追加

```markdown
### 3.5 実装計画 (docs/impl/)

| ファイル | 内容 | 正本 | 状態 |
|---------|------|:----:|------|
| [PLAN.md](../virtual-voicebot-backend/docs/impl/PLAN.md) | 実装ステップ計画 | ✓ | アクティブ |
| [TODO.md](../virtual-voicebot-backend/docs/impl/TODO.md) | 実装バックログ | ✓ | アクティブ |
```

---

## 質問リスト（回答済み）

### Claude Code 質問（Q1-Q3）

| # | 質問 | 回答 | 影響ファイル |
|---|------|:----:|-------------|
| Q1 | ルート AGENTS.md を「共通ルール + backend 参照」に限定してよいか？ | ✅ YES | /AGENTS.md |
| Q2 | current-spec.md（空ファイル）を削除してよいか？ | ✅ YES | backend/docs/current-spec.md |
| Q3 | design.md §2.3 の「UASのみ前提」未決事項を「確定」に移行してよいか？ | ✅ YES | backend/docs/design.md |

### Codex 指摘（CX-1〜CX-4）

| # | 質問 | 回答 | 根拠 | 影響ファイル |
|---|------|:----:|------|-------------|
| CX-1 | RTP → ai への直接 PCM 送信を許可するか？ | ❌ NO | 境界を守る。例外増殖を防ぐ。レイテンシは DTO/チャネル設計で対応 | design.md, rtp.md |
| CX-2 | MVP で HTTP Range 対応を必須とするか？ | ✅ YES | AGENTS.md E2E 要件と整合。ブラウザ再生/シークに必要 | contract.md, recording.md, tests.md |
| CX-3 | app/ai I/F の正本を voice_bot_flow.md にするか、ai.md/app.md に統合するか？ | **B** | DTO/必須フィールド/エラー/タイムアウトはテキストで書ける正本に | ai.md, app.md, voice_bot_flow.md |
| CX-4 | gap-analysis.md の AC を tests.md に移行するか？ | ✅ YES | V字トレース（要件→テスト）を通す | tests.md, gap-analysis.md |

---

### Codex フォローアップ指摘（CX-F1〜CX-F6）

2025-12-27 追加: CX-1〜CX-4 対応後の残存矛盾の修正

| # | 指摘 | 対応 |
|---|------|------|
| CX-F1 | design.md §6.1-6.3, §8.5, §9 に rtp↔ai 直接参照が残存 | ✅ 修正済み（session→app 経由に統一） |
| CX-F2 | rtp.md §2 で ai::asr/tts を依存先として記載 | ✅ 修正済み（禁止事項として明記） |
| CX-F3 | recording.md で Range「可能であれば」と「MVP必須」の混在 | ✅ 修正済み（MVP必須に統一） |
| CX-F4 | DOCS_POLICY.md §3.3 に ai.md/app.md/tests.md が未掲載 | ✅ 追加済み |
| CX-F5 | Correlation ID（call_id vs session_id）の不統一 | ✅ 修正済み（MVP: call_id == session_id を明記） |
| CX-F6 | voice_bot_flow.md に ai::tts→rtp 直接パスの記載 | ✅ 修正済み（app 経由を明記） |
| CX-F7 | design.md §8.5 と app.md §4 で連続失敗閾値が不一致（2回 vs 3回） | ✅ 修正済み（config 管理、既定: 2回に統一） |

**決定事項（エラー閾値）**: エラー閾値の不一致は config 管理で対応し、ドキュメントにはデフォルト値を記載する方針とした。

---

## 対応状況

### 即時対応（重大解消）
- [x] C-2: src/rtp/README.md を更新 ✅
- [x] C-3: gap-analysis.md の日付修正 ✅

### 合意後対応（Q1-Q3 回答後）
- [x] C-1: AGENTS.md 構成変更 ✅
- [x] M-4: current-spec.md 削除 ✅

### 改善対応
- [x] M-1: CLAUDE.md に責務分担表追加 ✅
- [x] M-2: DOCS_INDEX.md に impl/ セクション追加 ✅
- [x] M-3: DOCS_POLICY.md 階層図更新 ✅
- [x] M-5: backend AGENTS.md §10 リンク化 ✅
- [x] Q3/L-2: design.md の UAS 前提を確定事項に移行 ✅
- [x] L-1: DOCS_ANALYSIS.md 作業履歴追記 ✅
- [x] L-3: http/media/ai README リンク追加 ✅

### Codex フォローアップ対応
- [x] CX-F1: design.md §6,§8.5,§9 の rtp↔ai 直接参照削除 ✅
- [x] CX-F2: rtp.md §2 の依存方向修正 ✅
- [x] CX-F3: recording.md の Range 記述統一 ✅
- [x] CX-F4: DOCS_POLICY.md §3.3 に ai.md/app.md/tests.md 追加 ✅
- [x] CX-F5: Correlation ID 統一（call_id == session_id）✅
- [x] CX-F6: voice_bot_flow.md の app 経由明記 ✅
- [x] CX-F7: 連続失敗閾値を config 管理（既定: 2回）に統一（design.md, app.md）✅

---

## 付録: レビュー対象ファイル一覧

| ファイル | 確認結果 |
|---------|---------|
| /CLAUDE.md | レビュー任務定義あり |
| /AGENTS.md | ルート版（24行）|
| /virtual-voicebot-backend/AGENTS.md | Backend版（181行）|
| /docs/DOCS_POLICY.md | 正本ルール定義 |
| /docs/DOCS_INDEX.md | ドキュメント一覧（impl/ 未掲載）|
| /docs/DOCS_ANALYSIS.md | 過去分析結果 |
| /virtual-voicebot-backend/docs/design.md | アーキテクチャ設計（1000行）|
| /virtual-voicebot-backend/docs/gap-analysis.md | RFC準拠分析（日付不一致）|
| /virtual-voicebot-backend/docs/impl/PLAN.md | 実装計画 |
| /virtual-voicebot-backend/docs/impl/TODO.md | 実装バックログ |
| /virtual-voicebot-backend/docs/current-spec.md | 空ファイル |
| /virtual-voicebot-backend/src/rtp/README.md | 実態と乖離 |
| /virtual-voicebot-backend/src/sip/README.md | 整合 |
| /virtual-voicebot-backend/src/session/README.md | 整合 |
| /virtual-voicebot-backend/src/app/README.md | 整合 |
| /virtual-voicebot-backend/src/transport/README.md | 整合 |

---

*レビュー完了: 2025-12-27*
