# V字プロセス別チェックリスト（人間向け）

> 目的：仕様駆動で「迷い・手戻り・推測実装」を減らし、PoC→製品品質へ引き上げる。  
> 使い方：Issue作成/PR作成/マージ前に該当フェーズのチェックを使う（全部✅必須ではなく、未決はYes/No質問に落とす）。

---

## 1. 基本設計（System / Architecture）

- [ ] 目的（Why）と非目標（Not in scope）が明記されている
- [ ] SoT（正本）を明記した（どのdocsが正か）
- [ ] 責務境界（app/session/sip/rtp/transport/http/media/ai）を1文で説明できる
- [ ] 依存方向が一意で、例外があるなら明記されている
- [ ] 主要フロー（正常系）が箇条書き or 図で追える
- [ ] 失敗時ポリシー（timeout/retry/backpressure/fallback/終了条件）がある
- [ ] 相関ID（call_id等）の必須範囲が決まっている
- [ ] セキュリティ前提（認証/CORS/PIIログ/保存パス安全性）が決まっている
- [ ] 受入条件（AC）がある（testsに落とせる）

---

## 2. 詳細設計（Module / API / State）

- [ ] インタフェース（イベント/DTO/API）の正本が決まっている（app↔ai等）
- [ ] 必須フィールドが明記されている（call_id, stream_id, is_final等）
- [ ] イベント名・向き・責務がSoT間で一致（旧名は廃止注記）
- [ ] 状態機械（state）と遷移が列挙できる（入力→出力）
- [ ] 例外系（タイムアウト/キャンセル/再送/切断）の振る舞いが決まっている
- [ ] 並行モデルが明確（1セッション=1タスク、共有ロック方針など）
- [ ] リトライ/バックオフ/上限が決まっている（可能ならconfig化方針）
- [ ] ログ方針（必須キー、PIIはデフォルトで出さない）が明確
- [ ] テストに落とせる粒度になっている（入力→期待出力を文章化できる）

---

## 3. コーディング（Implementation）

- [ ] Refs（Issue）がある／ACがPR本文にある
- [ ] 1PR=1テーマで最小差分になっている
- [ ] 責務境界を破っていない（直呼び・内部詳細漏れがない）
- [ ] “将来拡張/念のため”で無意味な分岐・冗長バリデーションを増やしていない
- [ ] 失敗系を握りつぶしていない（結果/ログ/エラー伝播が適切）
- [ ] 外部I/Oに timeout を設定している
- [ ] backpressure方針に従っている（bounded/ドロップ/最新優先など）
- [ ] ログに相関IDが含まれる／PIIを出していない
- [ ] 設定値がハードコードされていない（URL/パス/閾値/時間）
- [ ] デバッグ用の一時コードが残っていない

---

## 4. 単体テスト（Unit）

- [ ] 純粋関数・パーサ・状態遷移は unit で押さえている
- [ ] 正常系 + 異常系（境界値）を最低1つずつ入れた
- [ ] 再現性がある（乱数はseed固定 or 注入可能）
- [ ] 外部I/Oはモック/フェイクで分離できている（trait境界など）
- [ ] テスト名が「何を保証するか」になっている
- [ ] `cargo test` で自動実行される配置になっている（`tests/` or `#[test]`）
- [ ] 失敗時に原因が追いやすい（アサーション/ログ/表示が適切）

---

## 5. 結合テスト（Integration）

- [ ] モジュール境界をまたぐ主要フローが通る（例：session↔sip/rtp）
- [ ] 非同期/タイミング要素をテスト可能にしている（clock注入、待ちは条件ベース）
- [ ] エラー系（タイムアウト/切断/再送）を最低1ケース含めた
- [ ] 前提（ポート/ディレクトリ/環境変数）が明記されている
- [ ] 並列実行に耐える（`127.0.0.1:0`、tempdir等）
- [ ] flakeしにくい（sleep頼みを避ける、待ちは上限付き）

---

## 6. E2Eテスト（System / E2E）

- [ ] ユーザー視点のACを満たす（tests/ACに紐付く）
- [ ] 実サーバを起動して検証する（例：`127.0.0.1:0`）
- [ ] 成功/失敗の代表ケースが揃っている（200/404/416等）
- [ ] CIで再現できる（外部依存を固定、docker compose等）
- [ ] 生成物（ログ/トレース/成果物）を保存できる（推奨：artifacts）
- [ ] セキュリティ事故を起こさない（テスト用トークン、PII抑止）
- [ ] 実行コマンドが明記されている（docs/tests等）

---

## 7. 運用メモ（軽量に回すコツ）

- Issue作成時：基本設計/詳細設計チェックを「未決＝Yes/No質問」に落とす
- PR作成時：コーディング/単体テストチェックを満たす
- マージ前：結合/E2EでACが担保されているか確認
