# RTP モジュール詳細設計 (`src/rtp`)

## 1. 目的・スコープ

- 目的:
  - RTP/RTCP パケット処理と音声ストリーム管理を担当する。
  - PCM と RTP ペイロードの相互変換を行い、ASR/TTS と連携できるようにする。
- スコープ:
  - 単一 SSRC / 単一コーデックの音声ストリーム（MVPでは G.711 PCMU/8000 のみ）
  - 安定した受信・送信パイプラインの構築
- 非スコープ:
  - 音声認識（ASR）や TTS の中身
  - SIP/SDP の解析（それは `sip`/`session` 側）

## 2. 依存関係

- 依存するモジュール:
  - `transport::packet`: RTP/RTCP 生パケットの送受信
- 依存されるモジュール:
  - `session`: SDP が決めたメディア設定の受け取り
  - `ai::asr`: PCM の入力先
  - `ai::tts`: PCM の供給元

## 3. 主な責務

1. RTP/RTCP パケット表現
   - RTP ヘッダ（SSRC, Seq, Timestamp, PayloadType, Marker, CSRC etc）
   - RTCP SR/RR の最小限の構造（MVP では後回しでも可）

2. パーサ / ビルダ
   - バイト列 ⇔ RTP/RTCP 構造体
   - 異常ケース（ヘッダ長不正など）のハンドリング

3. ストリーム管理
   - SSRC / (送信元 IP/Port) 単位のストリーム
   - Seq / Timestamp の管理
   - 受信バッファ（簡易ジッタバッファ）の方針
     - MVPでは「ほぼストレートに流す」でも良いが、TODO として残す

4. コーデック抽象
   - MVP: PCMU (G.711 μ-law) のみ
   - PCM ⇔ RTP ペイロードの変換 API を提供
   - 将来的なコーデック追加（PCMA/Opus 等）を視野に入れたインタフェース設計

5. ASR/TTS との連携
   - 受信: RTP → PCM → `ai::asr` へチャンク送信
   - 送信: `ai::tts` から PCM チャンクを引き取り、RTP にエンコードして送出

## 4. ストリームモデル

### 4.1 セッションとの紐付け

- `session` から渡される情報:
  - リモート IP/Port
  - ローカル送信ポート
  - コーデック (PayloadType)
  - SSRC を誰が決めるか（rtp 側で生成 or session 側から指定）
- `rtp` 内部では:
  - `(セッションID, SSRC)` をキーにストリームを管理
  - ストリームごとに Seq/Timestamp を持つ

### 4.2 受信側の流れ

1. `transport::packet` が RTP パケットを受信
2. `rtp` がヘッダ/ペイロードをパース
3. 該当ストリームを見つける（SSRC or IP/Port で）
4. 必要なら簡易的なジッタバッファ/整列処理
5. ペイロードを PCM にデコード
6. PCM チャンクを `ai::asr` に渡す（イベント or チャネル）

### 4.3 送信側の流れ

1. `ai::tts` から PCM チャンクを受け取る
2. コーデックで RTP ペイロードにエンコード
3. Seq/Timestamp をインクリメント
4. RTP ヘッダを組み立ててバイト列化
5. `transport::packet` に送信依頼

## 5. RTCP の扱い

- MVP:
  - RTCP は最低限の受信ログ程度に留める（処理しないなら明記）
- NEXT:
  - SR/RR の送受信
  - 受信品質からのメトリクス算出（パケットロス率等）

ここでは、「MVP 時点では何をしないか」も明示する。

## 6. エラー・タイムアウト処理

- 受信エラー:
  - ヘッダ異常 / ペイロード長異常 → ログ + パケット破棄
- RTP 無着信:
  - 一定時間（設定値）パケットが来ない場合 `RtpTimeout` イベントを `session` or `app` に送る
- コーデックエラー:
  - デコード不能の場合の扱い（無音扱い / スキップ / ログのみ等）

## 7. MVP と拡張範囲

- MVP で対応:
  - 単一 SSRC / 単一コーデック (PCMU)
  - ジッタバッファは最小限 or なし
  - RTCPは未対応 or ログのみ
- NEXT で追加:
  - ジッタバッファと再整列ロジック
  - RTCP SR/RR
  - 複数コーデック対応
